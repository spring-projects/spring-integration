[[cloudevents]]
= CloudEvents Support

Use Spring Integration transformers (starting with version 7.1) to transform messages into CloudEvent messages.
The implementation is fully based on the https://github.com/cloudevents/sdk-java[CloudEvents SDK] project.

Add the following dependency to your project:

[tabs]
======
Maven::
+
[source, xml, subs="normal", role="primary"]
----
<dependency>
    <groupId>org.springframework.integration</groupId>
    <artifactId>spring-integration-cloudevents</artifactId>
    <version>{project-version}</version>
</dependency>
----

Gradle::
+
[source, groovy, subs="normal", role="secondary"]
----
compile "org.springframework.integration:spring-integration-cloudevents:{project-version}"
----
======

[[to-cloud-event-transformer]]

=== `ToCloudEventTransformer`

Use the `ToCloudEventTransformer` to convert Spring Integration messages into CloudEvents compliant messages.
This transformer supports the CloudEvents specification v1.0, automatically serializes CloudEvents if an EventFormat or eventFormatContentTypeExpression is specified.
The transformer supports defining attributes using Expressions, and identifies extensions in the message headers via patterns.

NOTE: Ensure messages to be transformed have a payload of type `byte[]`.
The transformer throws an `IllegalArgumentException` if the payload is not a byte array.

==== Attribute Expressions

Set the CloudEvents' attributes of `id`, `source`, `type`, `dataSchema`, and `subject` through SpEL ``Expression``s.

NOTE: The transformer sets the `time` attribute to the time when it creates the CloudEvent message.

The following table lists the attribute names and the values the default ``Expression``s return.

|===
| Attribute Name | Default Value

| `id`
| The id of the message.

| `source`
| Prefix of "/spring/" followed by the appName, a period, and then the name of the transformer's bean (for example, `/spring/myapp.toCloudEventTransformerBean`).

| `type`
| "spring.message"

| `dataContentType`
| The contentType of the message, defaults to `application/octet-stream`.
Some other examples are but not limited to: `application/json`, `application/x-avro`, and `application/xml`.

| `dataSchema`
| `null`

| `subject`
| `null`

| `time`
| The time the CloudEvent message is created.
|===

==== Extension Patterns

Use the extensionPatterns constructor parameter (a vararg of strings) to specify pattern matching with wildcards (`*`).
The transformer includes message headers with keys matching any pattern as CloudEvent extensions.
Use a `!` prefix to explicitly exclude headers through negation.
Note that the first matching pattern wins (positive or negative).

For example, configure patterns `"trace*", "span-id", "user-id"` to:
- Include headers starting with `trace` (e.g., `trace-id`, `traceparent`)
- Include headers with exact keys `span-id` and `user-id`
- Add all matching headers as extensions to the CloudEvent

To exclude specific headers, use negated patterns: `"custom-*", "!custom-internal"` includes all headers starting with `custom-` except `custom-internal`.

[[constructors]]

==== Constructors

Choose from three constructors for flexible configuration:

[source,java]
----
// Default constructor - no EventFormat, no extension patterns
new ToCloudEventTransformer()

// Constructor with EventFormat injection
new ToCloudEventTransformer(eventFormat)

// Constructor with EventFormat and extension patterns
new ToCloudEventTransformer(eventFormat, "trace*", "span-id", "user-id")
----

[[configuration-with-dsl]]

==== Configuration With DSL

Add the CloudEvent transformer to flows using the DSL:

[source,java]
----
@Bean
public ToCloudEventTransformer cloudEventTransformer() {
    return new ToCloudEventTransformer(new JsonFormat(), "trace*", "correlation-id");
}

@Bean
public IntegrationFlow cloudEventTransformFlow(ToCloudEventTransformer toCloudEventTransformer) {
    return IntegrationFlows
        .from("inputChannel")
        .transform(toCloudEventTransformer)
        .channel("outputChannel")
        .get();
}
----

[[cloudevent-transformer-process]]

==== CloudEvent Transformer Process

Understand the transformation process:

1. **CloudEvent Building**: Build CloudEvent attributes.
2. **Extension Extraction**: Build the CloudEvent extensions using the array of extensionPatterns passed into the constructor.
3. **Format Conversion**: Apply the specified `EventFormat` or, if not set, handle conversion via Binary Format Mode.

A basic transformation may have the following pattern:

[source,java]
----
// Input message with headers
Message<byte[]> inputMessage = MessageBuilder
    .withPayload("Hello CloudEvents".getBytes(StandardCharsets.UTF_8))
    .withHeader(MessageHeaders.CONTENT_TYPE, "text/plain")
    .build();

ToCloudEventTransformer transformer = new ToCloudEventTransformer();

// Transform to CloudEvent
Object cloudEventMessage = transformer.transform(inputMessage);
----

[[eventformats]]

==== EventFormats
Use ``EventFormat``s to serialize the CloudEvent into the message's payload when the EventFormat is available, or use Binary Format Mode when an `EventFormat` is not available.
Set the EventFormat in one of two ways:

1. Set the desired `EventFormat` via the constructor
2. Set the `eventFormatContentTypeExpression` with an expression that resolves to a content type that `eventFormatProvider` can use to provide the required `EventFormat`.

However, when you do not specify the `EventFormat` via the constructor and the type is not supported by one of the cloudevents dependencies and `failOnNoFormat` is set to `false` (for example `text/plain`), the transformer adds cloud event attributes and extensions to the message headers with the cloud event prefix (default is `ce-`) and leaves the payload unchanged (Binary Format Mode).
When `failOnNoFormat` is set to `true`, the transformer throws a `MessageTransformationException` if it cannot find an `EventFormat`.

To utilize a specific `EventFormat`, add the associated dependency.
For example, to add the XML `EventFormat`, add the following dependency: `io.cloudevents:cloudevents-xml`.
See the https://github.com/cloudevents/sdk-java[CloudEvents SDK project's] reference docs for information on the ``EventFormat``s that are available.

